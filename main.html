<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Anime Watchlist</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="utils.css">
    <link rel="stylesheet" href="main.css">
</head>
<body>
    <header>
        <h1><i class="fas fa-tv"></i> My Anime Watchlist</h1>
        <p class="subtitle">Track what you've watched with multi-genre tagging</p>
    </header>
    
    <div class="container">
        <div class="panel">
            <div class="filter-section">
                <div class="filter-title">
                    <i class="fas fa-filter"></i> Filter by Genre
                </div>
                <div class="filter-actions">
                    <button class="btn-filter" data-filter="all">Show All</button>
                    <!-- Filter buttons will be added by JavaScript -->
                </div>
                <div class="active-filters" id="activeFilters">
                    <div class="no-filters">No active filters</div>
                </div>
            </div>
            
            <h2><i class="fas fa-list"></i> Watched Anime</h2>
            <ul class="anime-list" id="animeList">
                <!-- Anime items will be added here by JavaScript -->
            </ul>
        </div>
        
        <div class="panel">
            <h2><i class="fas fa-tags"></i> Anime Genres</h2>
            <div class="genre-list" id="genreList">
                <!-- Genre items will be added here by JavaScript -->
            </div>
        </div>
    </div>
    
    <div class="add-form">
        <h2 class="form-title"><i class="fas fa-plus-circle"></i> Add New Anime</h2>
        <form id="animeForm">
            <div class="form-group">
                <label for="animeTitle">Anime Title</label>
                <input type="text" id="animeTitle" placeholder="e.g., Attack on Titan" required>
            </div>
            
            <div class="form-group">
                <label>Select Genres (Multi-Select)</label>
                <div class="form-note">Click on genres to select/deselect them</div>
                <div class="genre-picker">
                    <div class="genre-picker-title">Available Genres:</div>
                    <div class="genre-options" id="genreOptions">
                        <!-- Genre options will be added by JavaScript -->
                    </div>
                    
                    <div class="genre-picker-title">Selected Genres:</div>
                    <div class="selected-genres" id="selectedGenresDisplay">
                        <div class="no-selection">No genres selected yet</div>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="animeEpisodes">Episodes Watched</label>
                <input type="number" id="animeEpisodes" placeholder="e.g., 25" min="1" required>
            </div>
            
            <button type="submit" class="btn btn-add" id="addButton">
                <i class="fas fa-plus"></i> Add to Watchlist
            </button>
        </form>
    </div>
    
    <div class="stats">
        <div class="stat-item">
            <div class="stat-value" id="totalAnime">0</div>
            <div class="stat-label">Total Anime</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="totalEpisodes">0</div>
            <div class="stat-label">Total Episodes</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="totalGenres">0</div>
            <div class="stat-label">Unique Genres</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="filteredCount">0</div>
            <div class="stat-label">Showing</div>
        </div>
    </div>
    
    <footer>
        <p>My Anime Watchlist &copy; <span id="currentYear"></span> • Track your anime journey</p>
        <p>Data is saved in your browser's local storage</p>
    </footer>

    <div class="status-message" id="statusMessage"></div>

    <!-- Import modules -->
    <script type="module">
        import { showStatus, genreColors, allGenres } from './utils.mjs'
        import { AnimeManager } from './anime.mjs'
        import { loadAnimeList, saveAnimeList } from './repository.mjs'
        
        // DOM elements
        const animeListEl = document.getElementById('animeList')
        const genreListEl = document.getElementById('genreList')
        const genreOptionsEl = document.getElementById('genreOptions')
        const selectedGenresDisplayEl = document.getElementById('selectedGenresDisplay')
        const animeForm = document.getElementById('animeForm')
        const addButton = document.getElementById('addButton')
        const totalAnimeEl = document.getElementById('totalAnime')
        const totalEpisodesEl = document.getElementById('totalEpisodes')
        const totalGenresEl = document.getElementById('totalGenres')
        const filteredCountEl = document.getElementById('filteredCount')
        const activeFiltersEl = document.getElementById('activeFilters')
        const statusMessageEl = document.getElementById('statusMessage')
        
        // Initialize anime manager
        const animeManager = new AnimeManager()
        
        // Load data and initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            // Set current year in footer
            document.getElementById('currentYear').textContent = new Date().getFullYear()
            
            // Load anime list from repository
            const loadedAnime = loadAnimeList()
            if (loadedAnime.length > 0) {
                animeManager.setAnimeList(loadedAnime)
            }
            
            // Initialize the app
            initApp()
        })
        
        // Initialize the application
        const initApp = () => {
            renderGenreOptions()
            renderGenreList()
            renderFilterButtons()
            renderAnimeList()
            updateStats()
            setupEventListeners()
        }
        
        // Set up event listeners
        const setupEventListeners = () => {
            // Form submission
            animeForm.addEventListener('submit', (e) => {
                e.preventDefault()
                addNewAnime()
            })
            
            // Update add button state based on form validity
            animeForm.addEventListener('input', () => {
                updateAddButtonState()
            })
            
            // "Show All" button
            document.querySelector('[data-filter="all"]').addEventListener('click', () => {
                animeManager.clearActiveFilters()
                updateFilterButtonsDisplay()
                updateActiveFiltersDisplay()
                renderAnimeList()
                updateStats()
            })
        }
        
        // Render genre options for multi-select
        const renderGenreOptions = () => {
            genreOptionsEl.innerHTML = ''
            
            allGenres.forEach(genre => {
                const option = document.createElement('div')
                option.className = 'genre-option'
                option.setAttribute('data-genre', genre)
                
                option.innerHTML = `
                    <span class="genre-color" style="background-color: ${genreColors[genre]}"></span>
                    <span>${genre}</span>
                `
                
                option.addEventListener('click', () => {
                    toggleGenreSelection(genre)
                })
                
                genreOptionsEl.appendChild(option)
            })
        }
        
        // Toggle genre selection in the form
        const toggleGenreSelection = (genre) => {
            animeManager.toggleSelectedGenre(genre)
            updateSelectedGenresDisplay()
            updateGenreOptionsDisplay()
            updateAddButtonState()
        }
        
        // Update the display of selected genres
        const updateSelectedGenresDisplay = () => {
            selectedGenresDisplayEl.innerHTML = ''
            const selectedGenres = animeManager.getSelectedGenres()
            
            if (selectedGenres.length === 0) {
                selectedGenresDisplayEl.innerHTML = '<div class="no-selection">No genres selected yet</div>'
                return
            }
            
            selectedGenres.forEach(genre => {
                const selectedGenre = document.createElement('div')
                selectedGenre.className = 'selected-genre'
                
                selectedGenre.innerHTML = `
                    <span class="genre-color" style="background-color: ${genreColors[genre]}"></span>
                    <span>${genre}</span>
                    <button class="remove-genre" data-genre="${genre}">×</button>
                `
                
                selectedGenresDisplayEl.appendChild(selectedGenre)
            })
            
            // Add event listeners to remove buttons
            document.querySelectorAll('.remove-genre').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation()
                    const genre = button.getAttribute('data-genre')
                    toggleGenreSelection(genre)
                })
            })
        }
        
        // Update genre options display (selected state)
        const updateGenreOptionsDisplay = () => {
            document.querySelectorAll('.genre-option').forEach(option => {
                const genre = option.getAttribute('data-genre')
                if (animeManager.isGenreSelected(genre)) {
                    option.classList.add('selected')
                } else {
                    option.classList.remove('selected')
                }
            })
        }
        
        // Update add button state
        const updateAddButtonState = () => {
            const title = document.getElementById('animeTitle').value.trim()
            const episodes = document.getElementById('animeEpisodes').value
            const hasSelectedGenres = animeManager.getSelectedGenres().length > 0
            
            addButton.disabled = !(title && episodes && hasSelectedGenres)
        }
        
        // Render filter buttons
        const renderFilterButtons = () => {
            const filterActions = document.querySelector('.filter-actions')
            
            // Clear existing filter buttons (except "Show All")
            const showAllBtn = document.querySelector('[data-filter="all"]')
            filterActions.innerHTML = ''
            filterActions.appendChild(showAllBtn)
            
            // Get all unique genres from anime list
            const uniqueGenres = animeManager.getAllUniqueGenres()
            
            // Create filter buttons for each genre
            uniqueGenres.forEach(genre => {
                const button = document.createElement('button')
                button.className = 'btn-filter'
                button.setAttribute('data-genre', genre)
                button.innerHTML = `
                    <span class="genre-color" style="background-color: ${genreColors[genre] || '#6a5acd'}; display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px;"></span>
                    ${genre}
                `
                
                button.addEventListener('click', () => {
                    toggleActiveFilter(genre)
                })
                
                filterActions.appendChild(button)
            })
            
            updateFilterButtonsDisplay()
        }
        
        // Toggle active filter
        const toggleActiveFilter = (genre) => {
            animeManager.toggleActiveFilter(genre)
            updateFilterButtonsDisplay()
            updateActiveFiltersDisplay()
            renderAnimeList()
            updateStats()
        }
        
        // Update filter buttons display (active state)
        const updateFilterButtonsDisplay = () => {
            document.querySelectorAll('.btn-filter').forEach(button => {
                const filterType = button.getAttribute('data-filter')
                const genre = button.getAttribute('data-genre')
                const activeFilters = animeManager.getActiveFilters()
                
                if (filterType === 'all') {
                    button.classList.toggle('active', activeFilters.length === 0)
                } else if (genre && activeFilters.includes(genre)) {
                    button.classList.add('active')
                } else {
                    button.classList.remove('active')
                }
            })
        }
        
        // Update active filters display
        const updateActiveFiltersDisplay = () => {
            activeFiltersEl.innerHTML = ''
            const activeFilters = animeManager.getActiveFilters()
            
            if (activeFilters.length === 0) {
                activeFiltersEl.innerHTML = '<div class="no-filters">No active filters</div>'
                return
            }
            
            activeFilters.forEach(genre => {
                const filter = document.createElement('div')
                filter.className = 'active-filter'
                
                filter.innerHTML = `
                    <span class="genre-color" style="background-color: ${genreColors[genre] || '#6a5acd'}"></span>
                    <span>${genre}</span>
                    <button class="remove-filter" data-genre="${genre}">×</button>
                `
                
                activeFiltersEl.appendChild(filter)
            })
            
            // Add event listeners to remove buttons
            document.querySelectorAll('.remove-filter').forEach(button => {
                button.addEventListener('click', () => {
                    const genre = button.getAttribute('data-genre')
                    toggleActiveFilter(genre)
                })
            })
        }
        
        // Render anime list
        const renderAnimeList = () => {
            animeListEl.innerHTML = ''
            
            // Get filtered anime
            const filteredAnime = animeManager.getFilteredAnime()
            filteredCountEl.textContent = filteredAnime.length
            
            if (filteredAnime.length === 0) {
                const activeFilters = animeManager.getActiveFilters()
                animeListEl.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-search"></i>
                        <p>No anime found with the selected filters.</p>
                        ${activeFilters.length > 0 ? 
                            '<p style="margin-top: 10px; font-size: 0.9rem;">Try changing your filter selection.</p>' : 
                            '<p style="margin-top: 10px; font-size: 0.9rem;">Add some anime using the form below!</p>'}
                    </div>
                `
                return
            }
            
            filteredAnime.forEach(anime => {
                const animeItem = document.createElement('li')
                animeItem.className = 'anime-item'
                animeItem.setAttribute('data-id', anime.id)
                
                // Create genre tags
                const genreTags = anime.genres.map(genre => 
                    `<span class="genre-tag" style="background-color: ${genreColors[genre] || '#6a5acd'}">${genre}</span>`
                ).join('')
                
                animeItem.innerHTML = `
                    <div class="anime-info">
                        <h3>${anime.title}</h3>
                        <div class="anime-meta">
                            <span><i class="far fa-eye"></i> ${anime.episodes} episodes</span>
                        </div>
                        <div class="anime-genres">
                            ${genreTags}
                        </div>
                    </div>
                    <div class="anime-actions">
                        <button class="btn btn-remove" data-id="${anime.id}">
                            <i class="fas fa-trash"></i> Remove
                        </button>
                    </div>
                `
                
                animeListEl.appendChild(animeItem)
            })
            
            // Add event listeners to remove buttons
            document.querySelectorAll('.btn-remove').forEach(button => {
                button.addEventListener('click', () => {
                    const id = parseInt(button.getAttribute('data-id'))
                    removeAnime(id)
                })
            })
        }
        
        // Render genre list with counts
        const renderGenreList = () => {
            genreListEl.innerHTML = ''
            
            // Count anime per genre
            const genreCount = animeManager.countAnimeByGenre()
            
            // Sort genres by count (descending)
            const sortedGenres = Object.entries(genreCount)
                .sort((a, b) => b[1] - a[1])
            
            sortedGenres.forEach(([genre, count]) => {
                const genreItem = document.createElement('div')
                genreItem.className = 'genre-item'
                
                genreItem.innerHTML = `
                    <span class="genre-color" style="background-color: ${genreColors[genre] || '#6a5acd'}"></span>
                    <span class="genre-name">${genre}</span>
                    <span class="genre-count">${count}</span>
                `
                
                genreListEl.appendChild(genreItem)
            })
        }
        
        // Update statistics
        const updateStats = () => {
            // Total anime count
            totalAnimeEl.textContent = animeManager.getTotalAnimeCount()
            
            // Total episodes count
            totalEpisodesEl.textContent = animeManager.getTotalEpisodesCount()
            
            // Total unique genres count
            totalGenresEl.textContent = animeManager.getAllUniqueGenres().length
        }
        
        // Remove anime from list
        const removeAnime = (id) => {
            animeManager.removeAnime(id)
            saveAnimeList(animeManager.getAnimeList())
            renderGenreList()
            renderFilterButtons()
            renderAnimeList()
            updateStats()
            showStatus("Anime removed from watchlist")
        }
        
        // Add new anime
        const addNewAnime = () => {
            const title = document.getElementById('animeTitle').value.trim()
            const episodes = parseInt(document.getElementById('animeEpisodes').value)
            const selectedGenres = animeManager.getSelectedGenres()
            
            if (!title || !episodes || selectedGenres.length === 0) {
                showStatus("Please fill in all fields and select at least one genre", "warning")
                return
            }
            
            // Add to list
            animeManager.addAnime(title, selectedGenres, episodes)
            
            // Save to repository
            saveAnimeList(animeManager.getAnimeList())
            
            // Reset form
            animeForm.reset()
            animeManager.clearSelectedGenres()
            updateSelectedGenresDisplay()
            updateGenreOptionsDisplay()
            updateAddButtonState()
            
            // Update UI
            renderGenreList()
            renderFilterButtons()
            renderAnimeList()
            updateStats()
            
            // Show success message
            showStatus(`${title} has been added to your watchlist!`)
        }
    </script>
</body>
</html>